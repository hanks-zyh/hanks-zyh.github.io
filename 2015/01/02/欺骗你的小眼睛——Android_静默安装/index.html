<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>欺骗你的小眼睛——Android 静默安装 | Hanks.xyz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="article">
<meta property="og:title" content="欺骗你的小眼睛——Android 静默安装">
<meta property="og:url" content="http://hanks.xyz/2015/01/02/欺骗你的小眼睛——Android_静默安装/index.html">
<meta property="og:site_name" content="Hanks.xyz">
<meta property="og:description">
<meta property="og:updated_time" content="2015-12-04T17:20:04.328Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="欺骗你的小眼睛——Android 静默安装">
<meta name="twitter:description">
  
  
    <link rel="icon" href="/favicon.png">
  
  <!-- <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'> -->
  <!-- <link href="//fonts.googleapis.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css"> -->
  <link href="//fonts.useso.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css">
  <link href='//fonts.useso.com/css?family=Open+Sans:300,600' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <a href="/" class="logo">Hanks.xyz</a>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
          <a class="main-nav-link" href="/about/index.html">关于</a>
        
          <a class="main-nav-link" href="/atom.xml">RSS</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://hanks.xyz"></form>
        </div>
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
        
        
          <a id="nav-github-link" class="nav-icon" href="https://github.com/hanks-zyh" title="Fork me on GitHub"></a>
        
      </nav>
    </div>
  </div>
</header>
      <nav id="mobile-nav" class="off">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="/about/index.html" class="mobile-nav-link">关于</a>
  
    <a href="/atom.xml" class="mobile-nav-link">RSS</a>
  
  <div id="search-form-wrap-mobile">
    <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://hanks.xyz"></form>
  </div>
</nav>
      <div class="outer">
        
        <section id="main"><article id="post-欺骗你的小眼睛——Android_静默安装" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/01/02/欺骗你的小眼睛——Android_静默安装/" class="article-date">
  <time datetime="2015-01-02T03:13:00.000Z" itemprop="datePublished">2015-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      欺骗你的小眼睛——Android 静默安装
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
<p style="text-align:left">我们一般代码调用安装apk会写下面的代码</p>
<p style="text-align:left"></p>
<pre code_snippet_id="569739" snippet_file_name="blog_20150102_1_7842544" name="code" class="java">Intent intent = new  Intent(Intent.ACTION_VIEW);
File apkFile = new File(Environment.getExternalStorageDirectory().getAbsolutePath()+&quot;/1.apk&quot;);
intent.setDataAndType(Uri.fromFile(apkFile),&quot;application/vnd.android.package-archive&quot;);
startActivity(intent);</pre>
<p></p>
<p style="text-align:left"><br>
</p>
<p style="text-align:left">我们安装apk时系统会分析apk，然后弹出如下图的提示</p>
<p style="text-align:left"><img src="" alt=""><img src="" alt=""><br>
</p>
<p style="text-align:left"><img src="" alt=""><br>
</p>
<p style="text-align:left">当我们点击安装后，系统会进行安装</p>
<p style="text-align:left">这里我们查看系统源码来看一下系统是怎么执行安装程序的</p>
<p style="text-align:left"><br>
</p>
<p style="text-align:left">首先我们找到<span style="font-size:18px"><strong>PackageInstallerActivity.java,</strong></span><span style="font-size:12px">一看命名规则就知道是apk安装的界面</span></p>
<p style="text-align:left"><span style="font-size:12px"><br>
</span></p>
<p style="text-align:left"><span style="font-size:12px">既然是Activity 那么我们首先来看<span style="color:#33ff33">onCreate()</span>方法</span></p>
<p style="text-align:left"><span style="font-size:12px"></span></p>
<pre code_snippet_id="569739" snippet_file_name="blog_20150102_2_3778679" name="code" class="java">@Override
    protected void onCreate(Bundle icicle) {
        super.onCreate(icicle);
        //get intent information  获取Intent信息
        final Intent intent = getIntent();
        mPackageURI = intent.getData();//apk的uri
        mPm = getPackageManager(); 
        mPkgInfo = PackageUtil.getPackageInfo(mPackageURI);
        
        // Check for parse errors 检查apk是否有错误
        if(mPkgInfo == null) {
            Log.w(TAG, &quot;Parse error when parsing manifest. Discontinuing installation&quot;);
            showDialogInner(DLG_PACKAGE_ERROR);
            return;
        }
        
        //set view
        requestWindowFeature(Window.FEATURE_NO_TITLE);
        setContentView(R.layout.install_start); //这就是上面的界面
        mInstallConfirm = findViewById(R.id.install_confirm_panel);
        mInstallConfirm.setVisibility(View.INVISIBLE);
        PackageUtil.AppSnippet as = PackageUtil.getAppSnippet(this,
                mPkgInfo.applicationInfo, mPackageURI);
        PackageUtil.initSnippetForNewApp(this, as, R.id.app_snippet);
       //check setting //是否设置了 允许安装未知来源，就是设置那里的
        if(!isInstallingUnknownAppsAllowed()) {
            //ask user to enable setting first
            showDialogInner(DLG_UNKNOWN_APPS);
            return;
        }
        initiateInstall();
    }
    </pre>
<p></p>
<p style="text-align:left"><span style="font-size:12px"><br>
</span></p>
<p style="text-align:left"><span style="font-size:12px"><br>
</span></p>
<p style="text-align:left"><span style="font-size:12px">然后看initiateInstall（）方法</span></p>
<p style="text-align:left"><span style="font-size:12px"></span></p>
<pre code_snippet_id="569739" snippet_file_name="blog_20150102_3_454787" name="code" class="java">  private void initiateInstall() {
        String pkgName = mPkgInfo.packageName;
        // Check if there is already a package on the device with this name
        // but it has been renamed to something else. //检查是否有相同包名的应用
        String[] oldName = mPm.canonicalToCurrentPackageNames(new String[] { pkgName });
        if (oldName != null &amp;&amp; oldName.length &gt; 0 &amp;&amp; oldName[0] != null) {
            pkgName = oldName[0];
            mPkgInfo.setPackageName(pkgName);
        }
        // Check if package is already installed. display confirmation dialog if replacing pkg检查是否已经安装过了
        try {
            mAppInfo = mPm.getApplicationInfo(pkgName,
                    PackageManager.GET_UNINSTALLED_PACKAGES);
        } catch (NameNotFoundException e) {
            mAppInfo = null;
        }
        if (mAppInfo == null) {
            startInstallConfirm();//安装
        } else {
            if(localLOGV) Log.i(TAG, &quot;Replacing existing package:&quot;+
                    mPkgInfo.applicationInfo.packageName);
            showDialogInner(DLG_REPLACE_APP);
        }
    }
    </pre><br>
<br>
<p></p>
<p style="text-align:left"><span style="font-size:12px">来到startInstallConfirm（）</span></p>
<p style="text-align:left"><span style="font-size:12px"></span></p>
<pre code_snippet_id="569739" snippet_file_name="blog_20150102_4_9573109" name="code" class="java">    private void startInstallConfirm() {
        LinearLayout permsSection = (LinearLayout) mInstallConfirm.findViewById(R.id.permissions_section);
        LinearLayout securityList = (LinearLayout) permsSection.findViewById(
                R.id.security_settings_list);
        boolean permVisible = false;
        if(mPkgInfo != null) {
            AppSecurityPermissions asp = new AppSecurityPermissions(this, mPkgInfo);
            if(asp.getPermissionCount() &gt; 0) {
                permVisible = true;
                securityList.addView(asp.getPermissionsView());
            }
        }
        if(!permVisible){
            permsSection.setVisibility(View.INVISIBLE);
        }
        mInstallConfirm.setVisibility(View.VISIBLE);
        mOk = (Button)findViewById(R.id.ok_button); //确认按钮
        mCancel = (Button)findViewById(R.id.cancel_button);
        mOk.setOnClickListener(this);
        mCancel.setOnClickListener(this);
    }
</pre><br>
找点击事件 onClick()
<p></p>
<p style="text-align:left"></p>
<pre code_snippet_id="569739" snippet_file_name="blog_20150102_5_9804247" name="code" class="java" style="font-size:12px;"> public void onClick(View v) {
        if(v == mOk) { //开始安装，弹出安装进度界面
            // Start subactivity to actually install the application
            Intent newIntent = new Intent();
            newIntent.putExtra(PackageUtil.INTENT_ATTR_APPLICATION_INFO,
                    mPkgInfo.applicationInfo);
            newIntent.setData(mPackageURI);
            newIntent.setClass(this, InstallAppProgress.class); //这里调到了InstallAppProgress.java
            String installerPackageName = getIntent().getStringExtra(Intent.EXTRA_INSTALLER_PACKAGE_NAME);
            if (installerPackageName != null) {
                newIntent.putExtra(Intent.EXTRA_INSTALLER_PACKAGE_NAME, installerPackageName);
            }
            if(localLOGV) Log.i(TAG, &quot;downloaded app uri=&quot;+mPackageURI);
            startActivity(newIntent);
            finish();
        } else if(v == mCancel) {
            // Cancel and finish
            finish();
        }
    }</pre><br>
<span style="font-size:12px">继续跟踪 到</span><span style="font-size:18px">InstallAppProgress.java &nbsp; 的onCreate()</span>
<p></p>
<p style="text-align:left"><span style="font-size:18px"></span></p>
<pre code_snippet_id="569739" snippet_file_name="blog_20150102_6_3067029" name="code" class="java">  @Override
    public void onCreate(Bundle icicle) {
        super.onCreate(icicle);
        Intent intent = getIntent();
        mAppInfo = intent.getParcelableExtra(PackageUtil.INTENT_ATTR_APPLICATION_INFO);
        mPackageURI = intent.getData();
        initView();
    }</pre><br>
initView();
<p></p>
<p style="text-align:left"><span style="font-size:18px"></span></p>
<pre code_snippet_id="569739" snippet_file_name="blog_20150102_7_7607723" name="code" class="java">    public void initView() {
        requestWindowFeature(Window.FEATURE_NO_TITLE);
        setContentView(R.layout.op_progress);
        int installFlags = 0; //设置錐lag
        PackageManager pm = getPackageManager();
        try {
            PackageInfo pi = pm.getPackageInfo(mAppInfo.packageName, 
                    PackageManager.GET_UNINSTALLED_PACKAGES);
            if(pi != null) {
                installFlags |= PackageManager.INSTALL_REPLACE_EXISTING; //替换已经存在的
            }
        } catch (NameNotFoundException e) {
        }
        if((installFlags &amp; PackageManager.INSTALL_REPLACE_EXISTING )!= 0) {
            Log.w(TAG, &quot;Replacing package:&quot; + mAppInfo.packageName);
        }
        PackageUtil.AppSnippet as = PackageUtil.getAppSnippet(this, mAppInfo,
                mPackageURI);
        mLabel = as.label;
        PackageUtil.initSnippetForNewApp(this, as, R.id.app_snippet);
        mStatusTextView = (TextView)findViewById(R.id.center_text);
        mStatusTextView.setText(R.string.installing);
        mProgressBar = (ProgressBar) findViewById(R.id.progress_bar);
        mProgressBar.setIndeterminate(true);
        // Hide button till progress is being displayed
        mOkPanel = (View)findViewById(R.id.buttons_panel);
        mDoneButton = (Button)findViewById(R.id.done_button);
        mLaunchButton = (Button)findViewById(R.id.launch_button);
        mOkPanel.setVisibility(View.INVISIBLE);

        String installerPackageName = getIntent().getStringExtra(
                Intent.EXTRA_INSTALLER_PACKAGE_NAME);
        PackageInstallObserver observer = new PackageInstallObserver();
        pm.installPackage(mPackageURI, observer, installFlags, installerPackageName);//安装的代码
    }
</pre><br>
<br>
<p></p>
<p style="text-align:left"><span style="font-size:18px">几经周折，总算找到了。。。</span></p>
<p style="text-align:left"><span style="font-size:18px">下几句 关键的</span></p>
<p style="text-align:left"><span style="font-size:18px">&nbsp; &nbsp; &nbsp; <span style="font-family:Comic Sans MS">
&nbsp; &nbsp;int installFlags = <span style="color:#ff0000">0</span>; //设置Flag<br>
&nbsp; &nbsp; &nbsp; &nbsp; PackageManager pm = getPackageManager();<br>
&nbsp; &nbsp; &nbsp; &nbsp; try {<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PackageInfo pi = pm.getPackageInfo(mAppInfo.packageName,&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PackageManager.GET_UNINSTALLED_PACKAGES);<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(pi != null) {<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; installFlags |= PackageManager.INSTALL_REPLACE_EXISTING; //替换已经存在的<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>
&nbsp; &nbsp; &nbsp; &nbsp; } catch (NameNotFoundException e) {<br>
&nbsp; &nbsp; &nbsp; &nbsp; }<br>
&nbsp; &nbsp; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; PackageUtil.AppSnippet as = PackageUtil.getAppSnippet(this, mAppInfo,<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mPackageURI);<br>
&nbsp; &nbsp; &nbsp; &nbsp; String installerPackageName = getIntent().getStringExtra(<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Intent.EXTRA_INSTALLER_PACKAGE_NAME);<br>
&nbsp; &nbsp; &nbsp; &nbsp; PackageInstallObserver observer = new PackageInstallObserver();<br>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color:#ff0000"> pm.installPackage(mPackageURI, observer, installFlags, installerPackageName);//安装的代</span></span></span></p>
<p style="text-align:left"><span style="font-size:18px"><br>
</span></p>
<p style="text-align:left"><span style="font-size:18px">我们可以通过上面的代码直接进行安装，</span></p>
<p style="text-align:left"><span style="font-size:18px">不过我们需要<span style="font-family:monospace; font-size:14px; white-space:pre-wrap">android.Manifest.permission#INSTALL_PACKAGE</span></span><span style="font-family:monospace; font-size:14px; white-space:pre-wrap">,</span></p>
<p style="text-align:left"><span style="font-family:monospace; font-size:14px; white-space:pre-wrap">此权限只有</span><span style="font-family:monospace; font-size:14px; white-space:pre-wrap">system</span><span style="font-family:monospace; font-size:14px; white-space:pre-wrap">应用</span><span style="font-family:monospace; font-size:14px; white-space:pre-wrap">才能使用.</span></p>
<p style="text-align:left"><span style="font-family:monospace; font-size:14px; white-space:pre-wrap">所以此应用必须放入system/app下,</span></p>
<p style="text-align:left"><span style="font-family:monospace; white-space:pre-wrap"></span></p>
<div><span style="font-size:24px">解决思路</span></div>
<div><span style="font-size:24px"><span style="color:#97CDCC">•</span>将我们的应用伪装成系统的应用</span></div>
<div><span style="font-size:24px">实现步骤</span></div>
<div><span style="font-size:24px"><span style="color:#97CDCC">•</span>共享系统UID</span></div>
<div><span style="font-size:24px"><span style="color:rgb(151,205,204)">•</span>使用系统签名（匹配签名需要公钥和密钥两个文件生成keystore）</span></div>
<span style="font-size:14px"><br>
</span>
<p></p>
<p style="text-align:left"><span style="font-size:12px"><br>
</span></p>
<p style="text-align:left"><span style="font-size:12px"><br>
</span></p>
<p style="text-align:left"><span style="font-size:24px">还有静默安装的一种方式是使用root权限 &nbsp;adb指令执行 install -r 进行安装</span></p>
<p style="text-align:left"><span style="font-size:12px"><br>
</span></p>
<p style="text-align:left"><span style="font-size:12px"><br>
</span></p>
<p style="text-align:left"><span style="font-size:12px"><br>
</span></p>
<p style="text-align:left"><br>
</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanks.xyz/2015/01/02/欺骗你的小眼睛——Android_静默安装/" data-id="ciielmlra001imi05w92xywme" class="article-share-link">Share</a>
      
      
    </footer>
  
  
</article>

  
<section id="comments">
    <!-- 多说分享框 -->
    <div class="ds-share flat" data-thread-key="/2015/01/02/欺骗你的小眼睛——Android_静默安装/" data-title="欺骗你的小眼睛——Android 静默安装" data-images="https://raw.githubusercontent.com/Hankiya/LoveOnline/master/Rich%20Format%20Vertical.png" data-content="欺骗你的小眼睛——Android 静默安装" data-url="http://hanks.xyz//2015/01/02/欺骗你的小眼睛——Android_静默安装/">
    <div class="ds-share-inline">
      <ul  class="ds-share-icons-16">

      	<li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
        <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
        <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
        <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
        <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>
      </ul>
      <div class="ds-share-icons-more">
      </div>
    </div>
   </div>
    <!-- 多说评论框 start -->
   	<div class="ds-thread" data-thread-key="/2015/01/02/欺骗你的小眼睛——Android_静默安装/" data-title="欺骗你的小眼睛——Android 静默安装" data-url="http://hanks.xyz//2015/01/02/欺骗你的小眼睛——Android_静默安装/"></div>
   <!-- 多说评论框 end -->
   <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
   <script type="text/javascript">
   var duoshuoQuery = {short_name:"hanks-zyh"};
   	(function() {
   		var ds = document.createElement('script');
   		ds.type = 'text/javascript';ds.async = true;
   		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
   		ds.charset = 'UTF-8';
   		(document.getElementsByTagName('head')[0]
   		 || document.getElementsByTagName('body')[0]).appendChild(ds);
   	})();
   	</script>
   <!-- 多说公共JS代码 end -->
</section>

</section>
      </div>
      <footer id="footer">
  
    <aside id="sidebar" class="outer">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/12/18/atom-nuclide/">Atom安装Nuclide</a>
          </li>
        
          <li>
            <a href="/2015/12/18/react-native-UIExplorer/">运行React-Native例子UIExplorer</a>
          </li>
        
          <li>
            <a href="/2015/12/15/react-native-start-md/">Ubuntu进行 React-Native 的开发</a>
          </li>
        
          <li>
            <a href="/2015/12/08/refactoring-plaid-1/">重构 Plaid app - 响应式的MVP模式(一)</a>
          </li>
        
          <li>
            <a href="/2015/12/06/rx_thread/">Rx中的线程切换</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Atom/" style="font-size: 10px;">Atom</a> <a href="/tags/Java/" style="font-size: 13.33px;">Java</a> <a href="/tags/OS-X/" style="font-size: 10px;">OS X</a> <a href="/tags/React-Native/" style="font-size: 13.33px;">React-Native</a> <a href="/tags/Refactoring/" style="font-size: 10px;">Refactoring</a> <a href="/tags/Rx/" style="font-size: 10px;">Rx</a> <a href="/tags/RxJava/" style="font-size: 10px;">RxJava</a> <a href="/tags/Rxandroid/" style="font-size: 10px;">Rxandroid</a> <a href="/tags/Rxjava/" style="font-size: 13.33px;">Rxjava</a> <a href="/tags/Ubuntu/" style="font-size: 16.67px;">Ubuntu</a> <a href="/tags/mac-os/" style="font-size: 10px;">mac os</a> <a href="/tags/virtualBox/" style="font-size: 10px;">virtualBox</a> <a href="/tags/必备知识/" style="font-size: 10px;">必备知识</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://kiya.space">kiya-z</a>
          </li>
        
          <li>
            <a href="http://hexo.io">Hexo</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
  
  <div class="outer footer_center">
    <div id="footer-info" class="inner">
      &copy; 2015 Hanks<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
  </br>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    </div>
  </div>
</footer>

    </div>
    

<script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/jquery.scrollLoading.js" type="text/javascript"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>