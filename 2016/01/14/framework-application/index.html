<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Framework分析-Application的onCreate | Hanks&#39; Websit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <script data-ad-client="ca-pub-8165670162444117" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <meta name="referrer" content="never">
  <meta name="description" content="ActivityThread并不是一个Thread，而是一个单纯的Java类，查看一下 ActivityThread 的源码final class ActivityThread ，并没有继承Thread或者实现Runnable接口，ActivityThread 其中包含 main 方法,程序的入口地方，怎么看出来的呢? 我们开发过程中总会出现程序异常信息，细心看一下log，查看最下面的几行，最终问">
<meta property="og:type" content="article">
<meta property="og:title" content="Framework分析-Application的onCreate">
<meta property="og:url" content="https://hanks.pub/2016/01/14/framework-application/index.html">
<meta property="og:site_name" content="Hanks&#39; Websit">
<meta property="og:description" content="ActivityThread并不是一个Thread，而是一个单纯的Java类，查看一下 ActivityThread 的源码final class ActivityThread ，并没有继承Thread或者实现Runnable接口，ActivityThread 其中包含 main 方法,程序的入口地方，怎么看出来的呢? 我们开发过程中总会出现程序异常信息，细心看一下log，查看最下面的几行，最终问">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://file.bmob.cn/M02/47/A0/oYYBAFaXVu6AJgBvAAKJVqakFkA353.png">
<meta property="article:published_time" content="2016-01-14T09:49:35.000Z">
<meta property="article:modified_time" content="2024-02-08T01:29:02.182Z">
<meta property="article:author" content="Hanks">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Framework">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://file.bmob.cn/M02/47/A0/oYYBAFaXVu6AJgBvAAKJVqakFkA353.png">
  
  
  <link href="https://fonts.googleapis.com/css?family=Fira+Code|Noto+Serif+SC&display=swap" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  

<meta name="generator" content="Hexo 7.1.1"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8165670162444117"
     crossorigin="anonymous"></script>
  <div id="header-outer" class="outer">
    <a href="/" class="logo"></a>
    <nav id="main-nav">
      <a id="main-nav-toggle" class="nav-icon"></a>
      
        <a class="main-nav-link" href="/archives">Archive</a>
      
        <a class="main-nav-link" href="/eye-video">Eye</a>
      
        <a class="main-nav-link" href="/atom.xml">Rss</a>
      
    </nav>
  </div>
</header>
      <nav id="mobile-nav" class="off">
  
    <a href="/archives" class="mobile-nav-link">Archive</a>
  
    <a href="/eye-video" class="mobile-nav-link">Eye</a>
  
    <a href="/atom.xml" class="mobile-nav-link">Rss</a>
  
</nav>
      <div class="outer">
        <section id="main"><article id="post-framework-application" class="article article-type-post" itemscope
  itemprop="blogPost">
  <div class="article-meta">
    
  </div>
  <div class="article-inner">
    
    
    <header class="article-header">
      
      
  
    <h1 class="article-title" itemprop="name">
      Framework分析-Application的onCreate
    </h1>
  

      
    </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      <p>ActivityThread并不是一个Thread，而是一个单纯的Java类，查看一下 <code>ActivityThread</code> 的源码<code>final class ActivityThread </code>，并没有继承Thread或者实现Runnable接口，<code>ActivityThread</code> 其中包含 <code>main</code> 方法,程序的入口地方，怎么看出来的呢? 我们开发过程中总会出现程序异常信息，细心看一下log，查看最下面的几行，最终问题出在 <code>android.app.ActivityThread.main</code>.</p>
<span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">AndroidRuntime:     at android.app.Activity.performCreate(Activity.java:5133)</span><br><span class="line">AndroidRuntime:     at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1087)</span><br><span class="line">AndroidRuntime:     at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2175)</span><br><span class="line">AndroidRuntime:     at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2261) </span><br><span class="line">AndroidRuntime:     at android.app.ActivityThread.access$600(ActivityThread.java:141) </span><br><span class="line">AndroidRuntime:     at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1256) </span><br><span class="line">AndroidRuntime:     at android.os.Handler.dispatchMessage(Handler.java:99) </span><br><span class="line">AndroidRuntime:     at android.os.Looper.loop(Looper.java:137) </span><br><span class="line">AndroidRuntime:     at android.app.ActivityThread.main(ActivityThread.java:5103) </span><br><span class="line">AndroidRuntime:     at java.lang.reflect.Method.invokeNative(Native Method) </span><br><span class="line">AndroidRuntime:     at java.lang.reflect.Method.invoke(Method.java:525) </span><br><span class="line">AndroidRuntime:     at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:737) </span><br><span class="line">AndroidRuntime:     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:553) </span><br><span class="line">AndroidRuntime:     at dalvik.system.NativeStart.main(Native Method) </span><br></pre></td></tr></table></figure>

<p>介绍相关几个类的结构:<br><code>class ApplicationThread extends ApplicationThreadNative</code><br><code>abstract class ApplicationThreadNative extends Binder implements IApplicationThread </code><br>ApplicationThread (Binder)对象。其中 Binder负责接收远程AMS的 IPC调用，接收到调用<br>后，则通过Handler把消息发送到消息队列，UI主线程会异步地从消息队列中取出消息并执行相应操作，比如 start、stop、pause 等。</p>
<p><code>class ActivityManagerService extends ActivityManagerNative</code><br><code>abstract class ActivityManagerNative extends Binder implements IActivityManager</code></p>
<p>从 <code>ActivityThread</code> 的<code>main()</code>方法开始分析，</p>
<h3 id="ActivityThread的main方法"><a href="#ActivityThread的main方法" class="headerlink" title="ActivityThread的main方法"></a>ActivityThread的main方法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    </span><br><span class="line">    //...</span><br><span class="line"></span><br><span class="line">    Looper.prepareMainLooper(); //主线程的Looper对象</span><br><span class="line"></span><br><span class="line">    ActivityThread thread = new ActivityThread(); // 创建ActivityThread</span><br><span class="line">    thread.attach(false); //</span><br><span class="line"></span><br><span class="line">    if (sMainThreadHandler == null) &#123;</span><br><span class="line">        sMainThreadHandler = thread.getHandler(); //主线程的Handler</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AsyncTask.init();</span><br><span class="line"></span><br><span class="line">    Looper.loop(); //消息循环</span><br><span class="line"> </span><br><span class="line">    //...</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="ActivityThread的attach方法"><a href="#ActivityThread的attach方法" class="headerlink" title="ActivityThread的attach方法"></a>ActivityThread的attach方法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> private void attach(boolean system) &#123;</span><br><span class="line">        </span><br><span class="line">        if (!system) &#123;</span><br><span class="line">        // ActivityManagerService(AMS)的代理对象，用于跟AMS通信, IActivityManager具体实现类是 ActivityManagerProxy</span><br><span class="line">        // ActivityManagerNative.getDefault返回ActivityManagerService的远程接口，即ActivityManagerProxy接口</span><br><span class="line">            IActivityManager mgr = ActivityManagerNative.getDefault(); </span><br><span class="line">            try &#123;</span><br><span class="line">                mgr.attachApplication(mAppThread);//  mAppThread是ActivityThread的成员变量， mAppThread = new ApplicationThread();</span><br><span class="line">            &#125; catch (RemoteException ex) &#123;</span><br><span class="line">                // Ignore</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // ...</span><br><span class="line">        &#125;       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>attach最终调用了<code>ActivityManagerService</code>的远程接口<code>ActivityManagerProxy</code>的<code>attachApplication</code>函数，传入的参数是mAppThread(ApplicationThread类型的Binder对象)，它的作用是用来进行进程间通信的.</p>
<h3 id="ActivityManagerProxy的attachApplication"><a href="#ActivityManagerProxy的attachApplication" class="headerlink" title="ActivityManagerProxy的attachApplication"></a>ActivityManagerProxy的attachApplication</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public void attachApplication(IApplicationThread app) throws RemoteException</span><br><span class="line">&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeStrongBinder(app.asBinder()); //将app对象加到data</span><br><span class="line">    mRemote.transact(ATTACH_APPLICATION_TRANSACTION, data, reply, 0);</span><br><span class="line">    //跟服务端通信，transact的最后一个参数的含义是执行IPC调用的模式，0 表示服务端执行完指定服务后会返回一定的数据；1 表示不返回任何数据</span><br><span class="line">    reply.readException();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出<code>attachApplication</code>方法其实就是进行远程通信，向服务端发起一个 <code>ATTACH_APPLICATION_TRANSACTION</code>的消息.</p>
<p>补充一下Android中的 <strong>Binder机制</strong>，来自《Android内核剖析》</p>
<p>Binder,英文的意思是别针、回形针。我们经常用别针把两张纸“别” 在一起，而在Andmid中，<br>Binder用于完成进程间通信（IPC)，即把多个进程“别”在一起。比如，普通应用程序可以调用音乐播放服务提供的播放、暂停、停止等功能。Binder工作在Linux层面，属于一个驱动，只是这个驱动不需要硬件，或者说其操作的硬件是基于一小段内存。从线程的角度来讲，Binder驱动代码运行在内核态，客户端程序调用Binder是通过系统调用完成的.<br>Binder是一种架构，这种架构提供了服务端接口、Binder驱动、客户端接口三个模块。<br>首先来看服务端。一个Binder服务端实际上就是一个Binder类的对象，该对象一旦创建，内部就<br>启动一个隐藏线程。该线程接下来会接收Binder驱动发送的消息，收到消息后，会执行到Binder对象中的onTransact()函数，并按照该函数的参数执行不同的服务代码。因此，要实现一个Binder服务，就必须重载onTransact()方法。<br>可以想象，重载 onTransact()函数的主要内容是把onTransact()函数的参数转换为服务函数的参数，而onTransact()函数的参数来源是客户端调用transact()函数时输入的，因此，如果transact()有固定格式的输入，那么 onTransact()就会有固定格式的输出。<br>下面再看Binder驱动。任意一个服务端Binder对象被创建时，同时会在Binder驱动中创建一个<br>mRemote对象，该对象的类型也是Binder类。客户端要访问远程服务时，都是通过mRemote对象。<br><img src="https://file.bmob.cn/M02/47/A0/oYYBAFaXVu6AJgBvAAKJVqakFkA353.png" alt="Binder机制"></p>
<p>根据上面的表示，客户端调用 <code>transact()</code>函数之后，服务端会在 <code>onTransact()</code>中收到客户端传递的消息, 那么在ActivityManagerService的<code>onTransact()</code>方法中查找：</p>
<h3 id="ActivityManagerService的onTransact"><a href="#ActivityManagerService的onTransact" class="headerlink" title="ActivityManagerService的onTransact"></a>ActivityManagerService的onTransact</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public boolean onTransact(int code, Parcel data, Parcel reply, int flags)</span><br><span class="line">        throws RemoteException &#123;</span><br><span class="line">    // ... </span><br><span class="line">    try &#123;</span><br><span class="line">        return super.onTransact(code, data, reply, flags); //其实是调用父类ActivityManagerNative的onTransact处理</span><br><span class="line">    &#125; catch (RuntimeException e) &#123;</span><br><span class="line">        // The activity manager only throws security exceptions, so let&#x27;s</span><br><span class="line">        // log all others.</span><br><span class="line">        if (!(e instanceof SecurityException)) &#123;</span><br><span class="line">            Slog.wtf(TAG, &quot;Activity Manager Crash&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        throw e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ActivityManagerNative的onTransact"><a href="#ActivityManagerNative的onTransact" class="headerlink" title="ActivityManagerNative的onTransact"></a>ActivityManagerNative的onTransact</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public boolean onTransact(int code, Parcel data, Parcel reply, int flags)</span><br><span class="line">            throws RemoteException &#123;</span><br><span class="line">        switch (code) &#123;</span><br><span class="line">        // ...</span><br><span class="line">        case ATTACH_APPLICATION_TRANSACTION: &#123;</span><br><span class="line">            data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">            IApplicationThread app = ApplicationThreadNative.asInterface(</span><br><span class="line">                    data.readStrongBinder()); // 取出客户端传过来的 app</span><br><span class="line">            if (app != null) &#123;</span><br><span class="line">                attachApplication(app); //调用 ActivityManagerService的attachApplication 方法</span><br><span class="line">            &#125;</span><br><span class="line">            reply.writeNoException();</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="ActivityManagerService的attachApplication"><a href="#ActivityManagerService的attachApplication" class="headerlink" title="ActivityManagerService的attachApplication"></a>ActivityManagerService的attachApplication</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public final void attachApplication(IApplicationThread thread) &#123;</span><br><span class="line">       synchronized (this) &#123;</span><br><span class="line">           int callingPid = Binder.getCallingPid();</span><br><span class="line">           final long origId = Binder.clearCallingIdentity();</span><br><span class="line">           attachApplicationLocked(thread, callingPid); //调用 attachApplicationLocked</span><br><span class="line">           Binder.restoreCallingIdentity(origId);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="ActivityManagerService的attachApplicationLocked"><a href="#ActivityManagerService的attachApplicationLocked" class="headerlink" title="ActivityManagerService的attachApplicationLocked"></a>ActivityManagerService的attachApplicationLocked</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private final boolean attachApplicationLocked(IApplicationThread thread,</span><br><span class="line">            int pid) &#123;</span><br><span class="line">        // ...</span><br><span class="line">         </span><br><span class="line">        thread.bindApplication(processName, appInfo, providers,</span><br><span class="line">                app.instrumentationClass, profileFile, profileFd, profileAutoStop,</span><br><span class="line">                app.instrumentationArguments, app.instrumentationWatcher,</span><br><span class="line">                app.instrumentationUiAutomationConnection, testMode, enableOpenGlTrace,</span><br><span class="line">                isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                new Configuration(mConfiguration), app.compat, getCommonServicesLocked(),</span><br><span class="line">                mCoreSettingsObserver.getCoreSettingsLocked());   //  </span><br><span class="line">        updateLruProcessLocked(app, false, null);</span><br><span class="line">        app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">       // ...</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>最终调用客户端的ApplicationThread的bindApplication</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> public final void bindApplication(String processName,</span><br><span class="line">                ApplicationInfo appInfo, List&lt;ProviderInfo&gt; providers,</span><br><span class="line">                ComponentName instrumentationName, String profileFile,</span><br><span class="line">                ParcelFileDescriptor profileFd, boolean autoStopProfiler,</span><br><span class="line">                Bundle instrumentationArgs, IInstrumentationWatcher instrumentationWatcher,</span><br><span class="line">                IUiAutomationConnection instrumentationUiConnection, int debugMode,</span><br><span class="line">                boolean enableOpenGlTrace, boolean isRestrictedBackupMode, boolean persistent,</span><br><span class="line">                Configuration config, CompatibilityInfo compatInfo, Map&lt;String, IBinder&gt; services,</span><br><span class="line">                Bundle coreSettings) &#123;</span><br><span class="line"></span><br><span class="line">		    if (services != null) &#123;</span><br><span class="line">		        // Setup the service cache in the ServiceManager</span><br><span class="line">		        ServiceManager.initServiceCache(services);</span><br><span class="line">		    &#125;</span><br><span class="line"></span><br><span class="line">		    setCoreSettings(coreSettings);</span><br><span class="line"></span><br><span class="line">		    AppBindData data = new AppBindData();</span><br><span class="line">		    data.processName = processName;</span><br><span class="line">		    data.appInfo = appInfo;</span><br><span class="line">		    data.providers = providers;</span><br><span class="line">		    data.instrumentationName = instrumentationName;</span><br><span class="line">		    data.instrumentationArgs = instrumentationArgs;</span><br><span class="line">		    data.instrumentationWatcher = instrumentationWatcher;</span><br><span class="line">		    data.instrumentationUiAutomationConnection = instrumentationUiConnection;</span><br><span class="line">		    data.debugMode = debugMode;</span><br><span class="line">		    data.enableOpenGlTrace = enableOpenGlTrace;</span><br><span class="line">		    data.restrictedBackupMode = isRestrictedBackupMode;</span><br><span class="line">		    data.persistent = persistent;</span><br><span class="line">		    data.config = config;</span><br><span class="line">		    data.compatInfo = compatInfo;</span><br><span class="line">		    data.initProfileFile = profileFile;</span><br><span class="line">		    data.initProfileFd = profileFd;</span><br><span class="line">		    data.initAutoStopProfiler = false;</span><br><span class="line">		    sendMessage(H.BIND_APPLICATION, data); // Handler发送消息</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回调到mH（Handler）的handleMessage方法，然后调用了 <code>handleBindApplication(data)</code> 方法</p>
<h3 id="ApplicationThread的handleBindApplication"><a href="#ApplicationThread的handleBindApplication" class="headerlink" title="ApplicationThread的handleBindApplication"></a>ApplicationThread的handleBindApplication</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">private void handleBindApplication(AppBindData data) &#123;</span><br><span class="line">        // ...</span><br><span class="line">        </span><br><span class="line">        // Allow disk access during application and provider setup. This could</span><br><span class="line">        // block processing ordered broadcasts, but later processing would</span><br><span class="line">        // probably end up doing the same disk access.</span><br><span class="line">        final StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();</span><br><span class="line">        try &#123;</span><br><span class="line">            // If the app is being launched for full backup or restore, bring it up in</span><br><span class="line">            // a restricted environment with the base application class.</span><br><span class="line">            Application app = data.info.makeApplication(data.restrictedBackupMode, null); //创建一个Application对象</span><br><span class="line">            mInitialApplication = app;</span><br><span class="line"></span><br><span class="line">            // don&#x27;t bring up providers in restricted mode; they may depend on the</span><br><span class="line">            // app&#x27;s custom Application class</span><br><span class="line">            if (!data.restrictedBackupMode) &#123;</span><br><span class="line">                List&lt;ProviderInfo&gt; providers = data.providers;</span><br><span class="line">                if (providers != null) &#123;</span><br><span class="line">                    installContentProviders(app, providers);</span><br><span class="line">                    // For process that contains content providers, we want to</span><br><span class="line">                    // ensure that the JIT is enabled &quot;at some point&quot;.</span><br><span class="line">                    mH.sendEmptyMessageDelayed(H.ENABLE_JIT, 10*1000);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Do this after providers, since instrumentation tests generally start their</span><br><span class="line">            // test thread at this point, and we don&#x27;t want that racing.</span><br><span class="line">            try &#123;</span><br><span class="line">                mInstrumentation.onCreate(data.instrumentationArgs);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception e) &#123;</span><br><span class="line">                throw new RuntimeException(</span><br><span class="line">                    &quot;Exception thrown in onCreate() of &quot;</span><br><span class="line">                    + data.instrumentationName + &quot;: &quot; + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                mInstrumentation.callApplicationOnCreate(app);// app是Application对象</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                if (!mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">                    throw new RuntimeException(</span><br><span class="line">                        &quot;Unable to create application &quot; + app.getClass().getName()</span><br><span class="line">                        + &quot;: &quot; + e.toString(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            StrictMode.setThreadPolicy(savedPolicy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>先是创建Application</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public Application makeApplication(boolean forceDefaultAppClass,</span><br><span class="line">        Instrumentation instrumentation) &#123;</span><br><span class="line">    if (mApplication != null) &#123;</span><br><span class="line">        return mApplication;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Application app = null;</span><br><span class="line"></span><br><span class="line">    String appClass = mApplicationInfo.className;</span><br><span class="line">    if (forceDefaultAppClass || (appClass == null)) &#123;</span><br><span class="line">        appClass = &quot;android.app.Application&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">        ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, this);</span><br><span class="line">        app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">                cl, appClass, appContext); // 由instrument通过反射创建Application</span><br><span class="line">        appContext.setOuterContext(app);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        if (!mActivityThread.mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">            throw new RuntimeException(</span><br><span class="line">                &quot;Unable to instantiate application &quot; + appClass</span><br><span class="line">                + &quot;: &quot; + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mActivityThread.mAllApplications.add(app);</span><br><span class="line">    mApplication = app;</span><br><span class="line"></span><br><span class="line">    if (instrumentation != null) &#123; //应为上面传过来的参数为null，所以不会执行下面的代码</span><br><span class="line">        try &#123;</span><br><span class="line">            instrumentation.callApplicationOnCreate(app);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            if (!instrumentation.onException(app, e)) &#123;</span><br><span class="line">                throw new RuntimeException(</span><br><span class="line">                    &quot;Unable to create application &quot; + app.getClass().getName()</span><br><span class="line">                    + &quot;: &quot; + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>终于找到了Application的onCreate方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Perform calling of the application&#x27;s &#123;@link Application#onCreate&#125;</span><br><span class="line"> * method.  The default implementation simply calls through to that method.</span><br><span class="line"> *</span><br><span class="line"> * &lt;p&gt;Note: This method will be called immediately after &#123;@link #onCreate(Bundle)&#125;.</span><br><span class="line"> * Often instrumentation tests start their test thread in onCreate(); you</span><br><span class="line"> * need to be careful of races between these.  (Well between it and</span><br><span class="line"> * everything else, but let&#x27;s start here.)</span><br><span class="line"> *</span><br><span class="line"> * @param app The application being created.</span><br><span class="line"> */</span><br><span class="line">public void callApplicationOnCreate(Application app) &#123;</span><br><span class="line">    app.onCreate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>概括一下就是，在<code>ActivityThread</code>的<code>main</code>方法中，通过IPC机制和远端进行通信，服务端<code>ActivityManagerService</code>收到消息发送消息通知客户端，客户端的 <code>ApplicationThread</code>收到消息后，通过<code>Handler</code>发送消息，调用<code>handleBindApplication</code>方法，最终是通过 <code>mInstrumentation.callApplicationOnCreate(app)</code>回调到<code>Application</code>的<code>onCreate</code>方法.</p>
<blockquote>
<p>文章来自： <a href="https://hanks.pub/">https://hanks.pub</a></p>
</blockquote>

      
    </div>
</article>

<!-- 上一页 下一页 -->


<nav id="article-nav">
  
    <a href="/2016/01/20/android-optimization/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="fa fa-chevron-left"></i><span>上一篇</span>
      <div class="article-nav-title">
        
          Android性能优化
        
      </div>
    </a>
  
  
    <a href="/2016/01/11/react-native-23333/" id="article-nav-older" class="article-nav-link-wrap">
      <i class="fa fa-chevron-left"></i><span>下一篇</span>
      <div class="article-nav-title">React-Native 鬼畜表情包app</div>
    </a>
  
</nav>



<!-- 相关文章 -->

<!--

    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
      			<a href="/2016/01/14/framework-application/">Framework分析-Application的onCreate</a>
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    
      		
    

-->


</section>
      </div>
      <footer id="footer">
  <div class="outer footer_center">
    <div id="footer-info" class="inner">
      
      &copy;2025<a target="_blank" rel="noopener" href="https://github.com/hanks-zyh"> Hanks</a>版权所有
      <br/>
      <a href="https://beian.miit.gov.cn/" target="_blank">豫ICP备2021022347号</a>
	  </div>
  </div>
 <div id="share">
  <a id="totop" title="" style="display: block;">返回顶部</a>
 </div>
</footer>

    </div>
    


<script src="/js/jquery.min.js"></script>


<script src="/js/jquery.scrollLoading.js"></script>





<script src="/js/script.js"></script>


<script src="/js/ads.js"></script>

  </div>
</body>
</html>
